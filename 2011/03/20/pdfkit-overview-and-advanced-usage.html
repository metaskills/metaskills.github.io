<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="author" content="Ken Collins" />
  <meta name="google-site-verification" content="W3DG-CkoWHypH24OfrGmGbMezvhC6AyLql4jLI7hXhI" />
  <meta name="description" content="The personal blog of Ken Collins aka MetaSkills" />
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="cleartype" content="on">
  
  <title>PDFKit Overview & Advanced Usage - Ken Collins @MetaSkills.net</title>
  <link rel="author" href="mailto:ken@metaskills.net" />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/site/icon-57x57.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/site/icon-114x114.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/site/icon-72x72.png">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/site/icon-144x144.png">
  <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/site/icon-60x60.png">
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/site/icon-120x120.png">
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/site/icon-76x76.png">
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/site/icon-152x152.png">
  <link rel="icon" type="image/png" sizes="196x196" href="/assets/site/icon-196x196.png">
  <link rel="icon" type="image/png" sizes="160x160" href="/assets/site/icon-160x160.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/site/icon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/site/icon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/site/icon-32x32.png">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://metaskills.net/feed.xml" />
  <meta name="apple-mobile-web-app-title" content="MetaSkills">
  <meta name="application-name" content="MetaSkills" />
  <meta name="msapplication-TileImage" content="/assets/site/icon-144x144.png">
  <meta name="msapplication-TileColor" content="052838">
  <link rel="stylesheet" href="/assets/site.css">
</head>

  <body>
    <section class="ms-Page ">
  <header class="ms-Page-header">
    <section class="ms-Page-header-bg">
      <object class="ms-Page-header-bg-svg" data="/assets/site/page-svg.svg" type="image/svg+xml"></object>
    </section>
    <section class="ms-Page-header-content">
      <div class="ms-Page-header-avatar">
<a class="ms-Avatar" href="/pages/colophon.html" title"About Ken Collins">
  <div class="ms-Avatar-flipable">
    <div class="ms-Avatar-front">
      <img class="ms-Avatar-img" alt="Ken Collins" src="/assets/site/avatar.jpg">
    </div>
    <div class="ms-Avatar-back">
      <svg class="ms-Avatar-aboutme" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="350px" height="47px" viewBox="0 0 350 47" preserveAspectRatio="xMidYMax meet" version="1.1"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(1.000, 1.000)"><path d="M161.250 4.91 L-0.014 -0.12 L17.975 44.67 L178.787 37.22 L330.559 44.67 L347.824 -0.12 L161.250 4.91 Z" fill="#E4522A"/><g stroke="#FFFBE1"><path d="M275.89 25.53 L290.71 25.53 L287.55 20.31 L321.9 20.31 "/><path d="M276.55 22.54 L291.36 22.54 L288.2 17.33 L322.56 17.33 "/></g><g stroke="#FFFBE1"><path d="M72.76 25.53 L57.94 25.53 L61.1 20.31 L26.75 20.31 "/><path d="M72.1 22.54 L57.29 22.54 L60.45 17.33 L26.09 17.33 "/></g></g><path d="M89.184 15.23 L81.776 15.23 L81.724 15.52 C83.226 16.68 83.64 17.12 83.64 18.6 L83.641 31.76 L89.184 31.76 L89.184 27.43 L90.842 27.43 C91.955 27.43 92.19 28.05 92.19 29.04 L92.189 31.76 L97.732 31.76 L97.732 27.98 C97.732 24.92 96.9 24.04 93.64 24.04 L98.327 15.23 L92.189 15.23 L89.184 24.74 L89.184 15.23 Z M113.357 25.72 L113.357 21.99 L109.109 21.99 L109.109 19.14 L115.247 19.14 L115.247 15.23 L101.701 15.23 L101.649 15.52 C103.151 16.68 103.57 17.12 103.57 18.6 L103.566 31.76 L115.507 31.76 L115.507 28.03 L109.109 28.03 L109.109 25.72 L113.357 25.72 Z M119.346 15.23 L119.294 15.52 C120.797 16.68 121.21 17.12 121.21 18.6 L121.211 31.76 L126.754 31.76 L126.754 18.83 L129.008 18.83 C129.888 18.83 130.02 19.12 130.02 20 L130.018 31.76 L135.561 31.76 L135.561 19.84 C135.561 16.48 134.68 15.23 131.05 15.23 L119.346 15.23 Z M161.112 25.88 L161.112 26.92 C161.112 28.05 160.91 28.37 160.08 28.37 L159.014 28.37 C158.160 28.37 157.95 28.05 157.95 26.92 L157.952 20.26 C157.952 19.12 158.16 18.86 159.01 18.86 L160.076 18.86 C160.905 18.86 161.11 19.12 161.11 20.26 L161.112 23 L166.707 23 L166.707 20.05 C166.707 16.43 165.8 15.23 162.43 15.23 L156.631 15.23 C153.264 15.23 152.36 16.43 152.36 20.05 L152.357 26.53 C152.357 30.72 153.89 31.76 156.92 31.76 L162.433 31.76 C165.801 31.76 166.71 30.88 166.71 27.12 L166.707 25.88 L161.112 25.88 Z M186.606 20.05 C186.606 16.43 185.7 15.23 182.33 15.23 L176.375 15.23 C173.008 15.23 172.1 16.43 172.1 20.05 L172.101 26.53 C172.101 30.72 173.63 31.76 176.66 31.76 L182.332 31.76 C185.700 31.76 186.61 30.88 186.61 27.12 L186.606 20.05 Z M181.011 26.92 C181.011 28.05 180.8 28.37 179.97 28.37 L178.758 28.37 C177.903 28.37 177.7 28.05 177.7 26.92 L177.696 20.26 C177.696 19.12 177.9 18.86 178.76 18.86 L179.975 18.86 C180.804 18.86 181.01 19.12 181.01 20.26 L181.011 26.92 Z M198.216 15.23 L190.808 15.23 L190.757 15.52 C192.259 16.68 192.67 17.12 192.67 18.6 L192.673 31.76 L203.863 31.76 L203.863 28.03 L198.216 28.03 L198.216 15.23 Z M214.230 15.23 L206.822 15.23 L206.770 15.52 C208.272 16.68 208.69 17.12 208.69 18.6 L208.687 31.76 L219.877 31.76 L219.877 28.03 L214.230 28.03 L214.230 15.23 Z M230.244 15.23 L222.836 15.23 L222.784 15.52 C224.286 16.68 224.7 17.12 224.7 18.6 L224.700 31.76 L230.244 31.76 L230.244 15.23 Z M234.653 15.23 L234.601 15.52 C236.103 16.68 236.52 17.12 236.52 18.6 L236.518 31.76 L242.061 31.76 L242.061 18.83 L244.314 18.83 C245.195 18.83 245.32 19.12 245.32 20 L245.325 31.76 L250.868 31.76 L250.868 19.84 C250.868 16.48 249.99 15.23 246.36 15.23 L234.653 15.23 Z M268.410 15.23 L258.696 15.23 C256.805 15.23 256.13 16.06 256.13 17.36 C256.132 17.88 256.37 18.55 256.7 19.07 L261.753 27.07 C261.830 27.18 261.88 27.36 261.88 27.51 C261.882 27.82 261.65 28.03 261.18 28.03 L255.743 28.03 L255.743 31.76 L266.130 31.76 C268.073 31.76 268.8 30.49 268.8 29.45 C268.798 28.75 268.49 28.21 268.18 27.74 L262.970 20.13 C262.841 19.92 262.76 19.77 262.76 19.61 C262.763 19.33 263.02 19.14 263.49 19.14 L268.410 19.14 L268.410 15.23 Z" fill="#FFFBE1"/></g></svg>

    </div>
  </div>
</a>
</div>
      <ul class="ms-Page-nav">
        <li class="ms-Page-nav-item">
          <a class="ms-Page-nav-link" href="/">HOME</a>
        </li>
        
          
          
          <li class="ms-Page-nav-item">
            <a class="ms-Page-nav-link" href="/categories/programming.html">Programming</a>
          </li>
        
          
          
          <li class="ms-Page-nav-item">
            <a class="ms-Page-nav-link" href="/categories/lifestyle.html">Lifestyle</a>
          </li>
        
      </ul>
      <div class="ms-Page-social"><div class="ms-Social">
  <a href="http://twitter.com/metaskills" title="MetaSkills On Twitter">
    <span class="ms-Social-icon ms-Social-icon--twitter"><i class="icon-twitter"></i></span>
  </a>
  <a href="https://github.com/metaskills/" title="MetaSkills On GitHub">
    <span class="ms-Social-icon ms-Social-icon--github"><i class="icon-github"></i></span>
  </a>
  <a href="http://www.linkedin.com/in/metaskills" title="Ken Collins On LinkedIn">
    <span class="ms-Social-icon ms-Social-icon--linkedin"><i class="icon-linkedin"></i></span>
  </a>
</div>
</div>
      <div class="ms-Page-blurb">
        Ruby, JavaScript, Sass, iOS. Stinky Cheese &amp; Beer Advocate. Working at CustomInk and loving it!
      </div>
    </section>
  </header>
  <article class="ms-Page-article">
    <article class="ms-Post">
  <header class="ms-Post-header">
    <time class="ms-Post-time" pubdate datetime="2011-03-20T00:00:00-04:00">
      2011 March 20
    </time>
    <h1 class="ms-Post-header-h1">PDFKit Overview & Advanced Usage</h1>
  </header>
  <p>
  Last week I had the pleasure of rewriting 4 years of legacy PDF::Writer code to <a href="http://github.com/pdfkit/PDFKit">PDFKit</a>. Why? Well drawing pdfs in ruby using libraries like PDF::Writer is like composing a webpage with an Etch A Sketch. In short, its a damn chore that involves a bunch of code that mixes both data and presentation. Sure there are gems like <a href="http://prawn.majesticseacreature.com/">Prawn</a> that make this much easier, but nothing beats drawing your pdf code in native HTML and CSS, and that is where <a href="http://code.google.com/p/wkhtmltopdf/">wkhtmltopdf</a> comes in.
</p>

<p>
  Wkhtmltopdf is an open source project that uses the <a href="http://www.webkit.org/">WebKit</a> rendering engine to convert HTML to native PDF code. This is the muscle behind the PDFKit gem and other projects like <a href="https://github.com/mileszs/wicked_pdf">WickedPdf</a>. In this article I am only going to focus on PDFKit with Rails. But many topics will apply to both PDFKit and WickedPdf since they use wkhtmltopdf on the backside.
</p>

<h2>Installation</h2>

<p>
  Installing the PDFKit gem is a no brainer. The hard part is getting the wkhtmltopdf binaries for you platform installed. Thankfully the google project page hosts a batch of static binaries that work on just about every platform. So <a href="http://code.google.com/p/wkhtmltopdf/downloads/list">go to their download page</a> and pick the statically compiled binary that meets your needs. I highly suggest that you get the latest 0.10.0rc2 since some topics below take advantage of recent bug fixes. I have tested both the OSX and i386 on RHEL with success and the release candidate seems very production ready. I suggest placing wkhtmltopdf in <code>/usr/local/bin/wkhtmltopdf</code>.
</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ which wkhtmltopdf
/usr/local/bin/wkhtmltopdf
</code></pre></div>
<h2>The Basic Requirements</h2>

<p>
  I knew that HTML to PDF generation has its drawbacks, specifically with common headers/footers and page breaks. I happily found out that wkhtmltopdf has a solution for all these problems and can layout PDF pages with pixel perfect precision. So let's skip over the <a href="https://github.com/pdfkit/PDFKit/wiki">basics</a> and get right down to using PDFKit like a pro. We are going to build out the Rails HTML/CSS layouts and templates that will solve a series of common problems.
</p>

<p>
  The major reason to use PDFKit and wkhtmltopdf is that we can use the same templating system in Rails that we use to generate other views. This means that we test our PDF view code just like any other Rails code using its built-in functional or integration test cases. Let me say that again, we can TEST our PDF code! A huge win if you have complex conditional view code. So let's get to it.
</p>

<h2>The Main PDF Layout</h2>

<p>
  Sometimes it is useful to start at the end. So the first thing we need is a new layout for all of our pdf templates to use. Here is a <a href="http://haml-lang.com/">HAML</a> file that I recommend you name <code>app/views/layouts/pdf.html.pdf.haml</code>. Did you see that name? <strong>This is important!</strong> because Rails allows us to specify template names that can service more than one mime type format. So in this case, the layout will be found when rendering both HTML and .pdf formats.
</p>

<aside class="ms-Flash">
  Somewhere along the way to Rails 3, dual mime type support was lost. Now to render a template/partial for multiple mime types you must remove them all together from the name. Thereby making the file a catch-all for any mime type. In this case, pdf.haml would work.
</aside>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">!!!</span> <span class="mi">5</span>
<span class="o">%</span><span class="n">html</span><span class="p">{</span><span class="ss">:lang</span> <span class="o">=&gt;</span> <span class="s1">'en'</span><span class="p">}</span>
  <span class="o">%</span><span class="n">head</span>
    <span class="o">%</span><span class="n">meta</span><span class="p">{</span><span class="ss">:charset</span> <span class="o">=&gt;</span> <span class="s1">'utf-8'</span><span class="p">}</span>
    <span class="o">%</span><span class="n">meta</span><span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'pdfkit-footer_html'</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">pdf_footer_url</span><span class="p">}</span>
    <span class="o">=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"</span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">protocol</span><span class="si">}#{</span><span class="n">request</span><span class="p">.</span><span class="nf">host_with_port</span><span class="si">}</span><span class="s2">/stylesheets/pdf.css"</span>
  <span class="o">%</span><span class="n">body</span>
    <span class="o">=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:layout</span><span class="p">)</span>
</code></pre></div>
<p>
  <strong>I recommend that all PDF layouts, templates, and partials use the dual mime type naming convention.</strong> This will allow you to test your rendered HTML to PDF view code using common DOM techniques. Like <code>assert_select</code> in rails or maybe <a href="https://github.com/jnicklas/capybara">capybara's</a> <code>has_selector?</code>. So given that you may have a print action for your orders controller, you would use <code>print_orders_path(@order)</code> for your functional tests with DOM assertions and <code>print_orders_path(@order,:format=>:pdf)</code> for real world usage and/or integration tests. Both formats will render the same partials, templates and layouts if you use that naming structure.
</p>

<p>
  So that layout file is a real basic HTML5 doctype (which WebKit handles just fine) plus a few special elements. I'll cover that <code>pdfkit-footer_html</code> meta tag later on. For now, let's focus on that <code>pdf.css</code> stylesheet.
</p>

<h2>Your PDF CSS</h2>

<p>
  You might be tempted to utilize your existing site's stylesheets for a base and then use media/print techniques to override and customize your printed versions. I am of the opinion that your PDF stylesheets should be very basic and easy to layout. To this end, I highly suggest that you start with an HTML reset CSS. In the example below, I have used <a href="http://yui.yahooapis.com/3.2.0/build/cssreset/reset-min.css">Yahoo's CSS reset</a>. This makes it so that every bit of layout is under your strict control with a common rendering of no margin or padding to throw you off.
</p>
<div class="highlight"><pre><code class="language-css" data-lang="css"><span class="c">/* Reset CSS. http://yui.yahooapis.com/3.2.0/build/cssreset/reset-min.css  */</span>
<span class="nt">html</span><span class="p">{</span><span class="nl">color</span><span class="p">:</span><span class="m">#000</span><span class="p">;</span><span class="nl">background</span><span class="p">:</span><span class="m">#FFF</span><span class="p">;}</span><span class="nt">body</span><span class="o">,</span><span class="nt">div</span><span class="o">,</span><span class="nt">dl</span><span class="o">,</span><span class="nt">dt</span><span class="o">,</span><span class="nt">dd</span><span class="o">,</span><span class="nt">ul</span><span class="o">,</span><span class="nt">ol</span><span class="o">,</span><span class="nt">li</span><span class="o">,</span><span class="nt">h1</span><span class="o">,</span><span class="nt">h2</span><span class="o">,</span><span class="nt">h3</span><span class="o">,</span><span class="nt">h4</span><span class="o">,</span><span class="nt">h5</span><span class="o">,</span><span class="nt">h6</span><span class="o">,</span>
<span class="nt">pre</span><span class="o">,</span><span class="nt">code</span><span class="o">,</span><span class="nt">form</span><span class="o">,</span><span class="nt">fieldset</span><span class="o">,</span><span class="nt">legend</span><span class="o">,</span><span class="nt">input</span><span class="o">,</span><span class="nt">textarea</span><span class="o">,</span><span class="nt">p</span><span class="o">,</span><span class="nt">blockquote</span><span class="o">,</span><span class="nt">th</span><span class="o">,</span><span class="nt">td</span><span class="p">{</span><span class="nl">margin</span><span class="p">:</span><span class="m">0</span><span class="p">;</span><span class="nl">padding</span><span class="p">:</span><span class="m">0</span><span class="p">;}</span>
<span class="nt">table</span><span class="p">{</span><span class="nl">border-collapse</span><span class="p">:</span><span class="nb">collapse</span><span class="p">;</span><span class="nl">border-spacing</span><span class="p">:</span><span class="m">0</span><span class="p">;}</span><span class="nt">fieldset</span><span class="o">,</span><span class="nt">img</span><span class="p">{</span><span class="nl">border</span><span class="p">:</span><span class="m">0</span><span class="p">;}</span><span class="nt">address</span><span class="o">,</span><span class="nt">caption</span><span class="o">,</span>
<span class="nt">cite</span><span class="o">,</span><span class="nt">code</span><span class="o">,</span><span class="nt">dfn</span><span class="o">,</span><span class="nt">em</span><span class="o">,</span><span class="nt">strong</span><span class="o">,</span><span class="nt">th</span><span class="o">,</span><span class="nt">var</span><span class="p">{</span><span class="nl">font-style</span><span class="p">:</span><span class="nb">normal</span><span class="p">;</span><span class="nl">font-weight</span><span class="p">:</span><span class="nb">normal</span><span class="p">;}</span><span class="nt">li</span><span class="p">{</span><span class="nl">list-style</span><span class="p">:</span><span class="nb">none</span><span class="p">;}</span>
<span class="nt">caption</span><span class="o">,</span><span class="nt">th</span><span class="p">{</span><span class="nl">text-align</span><span class="p">:</span><span class="nb">left</span><span class="p">;}</span><span class="nt">h1</span><span class="o">,</span><span class="nt">h2</span><span class="o">,</span><span class="nt">h3</span><span class="o">,</span><span class="nt">h4</span><span class="o">,</span><span class="nt">h5</span><span class="o">,</span><span class="nt">h6</span><span class="p">{</span><span class="nl">font-size</span><span class="p">:</span><span class="m">100%</span><span class="p">;</span><span class="nl">font-weight</span><span class="p">:</span><span class="nb">normal</span><span class="p">;}</span>
<span class="nt">q</span><span class="nd">:before</span><span class="o">,</span><span class="nt">q</span><span class="nd">:after</span><span class="p">{</span><span class="nl">content</span><span class="p">:</span><span class="s2">''</span><span class="p">;}</span><span class="nt">abbr</span><span class="o">,</span><span class="nt">acronym</span><span class="p">{</span><span class="nl">border</span><span class="p">:</span><span class="m">0</span><span class="p">;</span><span class="nl">font-variant</span><span class="p">:</span><span class="nb">normal</span><span class="p">;}</span>
<span class="nt">sup</span><span class="p">{</span><span class="nl">vertical-align</span><span class="p">:</span><span class="nb">text-top</span><span class="p">;}</span><span class="nt">sub</span><span class="p">{</span><span class="nl">vertical-align</span><span class="p">:</span><span class="nb">text-bottom</span><span class="p">;}</span><span class="nt">input</span><span class="o">,</span><span class="nt">textarea</span><span class="o">,</span>
<span class="nt">select</span><span class="p">{</span><span class="nl">font-family</span><span class="p">:</span><span class="nb">inherit</span><span class="p">;</span><span class="nl">font-size</span><span class="p">:</span><span class="nb">inherit</span><span class="p">;</span><span class="nl">font-weight</span><span class="p">:</span><span class="nb">inherit</span><span class="p">;}</span><span class="nt">input</span><span class="o">,</span><span class="nt">textarea</span><span class="o">,</span>
<span class="nt">select</span><span class="p">{</span><span class="err">*</span><span class="nl">font-size</span><span class="p">:</span><span class="m">100%</span><span class="p">;}</span><span class="nt">legend</span><span class="p">{</span><span class="nl">color</span><span class="p">:</span><span class="m">#000</span><span class="p">;}</span>

<span class="c">/* Your Base Foundation */</span>
<span class="nt">html</span><span class="o">,</span><span class="nt">body</span> <span class="p">{</span> <span class="nl">font-family</span><span class="p">:</span> <span class="nb">sans-serif</span><span class="p">;</span> <span class="nl">font-size</span><span class="p">:</span><span class="m">12px</span><span class="p">;</span> <span class="p">}</span>
<span class="nt">h1</span> <span class="p">{</span> <span class="nl">font-size</span><span class="p">:</span><span class="m">18px</span><span class="p">;</span> <span class="p">}</span>
<span class="nt">h2</span> <span class="p">{</span> <span class="nl">font-size</span><span class="p">:</span><span class="m">16px</span><span class="p">;</span> <span class="p">}</span>
<span class="nt">h3</span> <span class="p">{</span> <span class="nl">font-size</span><span class="p">:</span><span class="m">14px</span><span class="p">;</span> <span class="p">}</span>
<span class="nt">h4</span> <span class="p">{</span> <span class="nl">font-size</span><span class="p">:</span><span class="m">12px</span><span class="p">;</span> <span class="p">}</span>
<span class="nt">strong</span> <span class="p">{</span> <span class="nl">font-weight</span><span class="p">:</span><span class="m">900</span> <span class="cp">!important</span><span class="p">;</span> <span class="p">}</span>
<span class="nt">hr</span>     <span class="p">{</span> <span class="nl">border</span><span class="p">:</span><span class="m">0</span><span class="p">;</span> <span class="nl">margin</span><span class="p">:</span><span class="m">0</span><span class="p">;</span> <span class="nl">padding</span><span class="p">:</span><span class="m">0</span><span class="p">;</span> <span class="nl">height</span><span class="p">:</span><span class="m">1px</span><span class="p">;</span> <span class="nl">color</span><span class="p">:</span><span class="m">#000</span><span class="p">;</span> <span class="nl">background-color</span><span class="p">:</span><span class="m">#000</span><span class="p">;</span> <span class="p">}</span>

<span class="c">/* Page Breaks */</span>
<span class="nc">.pb_before</span> <span class="p">{</span> <span class="nl">page-break-before</span><span class="p">:</span><span class="nb">always</span> <span class="cp">!important</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.pb_after</span>  <span class="p">{</span> <span class="nl">page-break-after</span><span class="p">:</span><span class="nb">always</span> <span class="cp">!important</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.pbi_avoid</span> <span class="p">{</span> <span class="nl">page-break-inside</span><span class="p">:</span><span class="nb">avoid</span> <span class="cp">!important</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>
<p>
  The second section of the CSS above is the place where you can put in a few custom styles that fit your needs. In my example I set a series of header font sizes, a base sans-serif font face and an hr tag that can be used as a simple rule. Feel free to add others here like basic styles for data tables, etc. The last section of the CSS file above are page break helpers. The latest version of wkhtmltopdf never breaks text in the middle of the line anymore. So most of the time the default page break behavior will work fine. But for those situations where you need more control, these 3 CSS declarations will serve most of your needs. Let's take a look at a few examples of their usage. Full details on <a href="http://www.w3.org/TR/css3-page/">CSS paged media</a> can be found on the W3C's site.
</p>

<p>
  Use the <code>.pbi_avoid</code> class on any block level element that you want to make sure is never broken across multiple pages. A great usage would be on each element of an orders line items. It can also be used on any large page element that will certainly fit on one page, but should never be broken up. This is perfect in places where you might have measured the remaining page space before drawing said element. The <code>.pb_before</code> class will always break to a new page. I found this very useful when printing composite PDF files that combined multiple other PDF actions. So here is another HAML template that renders 3 other PDF full page partials. Each partial can be 1 to many pages. By enclosing each in a <code><div></code> tag that forces a new page break makes sure that we always start a new page when rendering each document.
</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">%</span><span class="n">div</span><span class="p">.</span><span class="nf">pb_before</span>
  <span class="o">=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s1">'pdf/orders/print'</span>
<span class="o">%</span><span class="n">div</span><span class="p">.</span><span class="nf">pb_before</span>
  <span class="o">=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s1">'pdf/orders/invoice'</span>
<span class="o">%</span><span class="n">div</span><span class="p">.</span><span class="nf">pb_before</span>
  <span class="o">=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s1">'pdf/orders/picklist'</span>
</code></pre></div>
<h2>Custom Headers/Footers</h2>

<p>
  PDFKit and specifically wkhtmltopdf handles common page headers and footers just wonderfully, though it did take me some time to figure it out. I'll try to spare you the same pain by detailing the process for a custom footer on each page. In this example we will expect that our custom footer will be approximately .2 inches tall with a current page number next to a total page count.
</p>

<p>
  Remember that <code>pdfkit-footer_html</code> meta tag in the pdf layout above? If not, here it is again.
</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">%</span><span class="n">meta</span><span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'pdfkit-footer_html'</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">pdf_footer_url</span><span class="p">}</span>
</code></pre></div>
<p>
  So what is going on here? Two things really. The first is a way for PDFKit to customize the command arguments passed down to wkhtmltopdf when the page is converted. PDFKit will take any meta tag with a name prefixed using "pdfkit-" and pass down the content attribute as the value to the suffix of the name attribute. In this case <code>--foter-html http://myapp.com/pdf/footer</code> will be used as a command argument to wkhtmltopdf when rendering templates using that layout file. Note, it is important to use fully qualified URLs for header and footer arguments.
</p>

<p>
  When it comes to headers and footers, wkhtmltopdf takes the URL to an HTML page, renders it to native PDF code and embeds it automatically for you below or above your page margin. You can control the placement of these in one of two ways. The first is by adjusting the layout of the header/footer HTML page. The second is by adjusting the margin of the parent document. In my case, since I knew my footer was around .2 inches tall, I gave it's template an internal top margin of 10 pixels and told PDFKit to increase my global .5 inch page margins by .2 inches for the bottom margin using a rails initializer.
</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">PDFKit</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">default_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:page_size</span>     <span class="o">=&gt;</span> <span class="s1">'Letter'</span><span class="p">,</span>
    <span class="ss">:margin_top</span>    <span class="o">=&gt;</span> <span class="s1">'0.5in'</span><span class="p">,</span>
    <span class="ss">:margin_right</span>  <span class="o">=&gt;</span> <span class="s1">'0.5in'</span><span class="p">,</span>
    <span class="ss">:margin_bottom</span> <span class="o">=&gt;</span> <span class="s1">'0.7in'</span><span class="p">,</span>
    <span class="ss">:margin_left</span>   <span class="o">=&gt;</span> <span class="s1">'0.5in'</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>
  So now I know that whatever content I render in my <code>http://myapp.com/pdf/footer</code> page will fit just nicely on the bottom of each page. But how to generate that content and the custom page numbers? First, let's make a single pdf resource in our rails route file with a collection action for #footer. Now here is a controller for that resource with a single footer action.
</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PdfController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform_caching</span> <span class="p">;</span> <span class="kp">true</span> <span class="p">;</span> <span class="k">end</span>
  <span class="n">caches_page</span> <span class="ss">:footer</span>

  <span class="k">def</span> <span class="nf">footer</span>
    <span class="n">render</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">perform_caching</span>
    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<p>
  There is not much here past rendering a basic template file with no layout. All the rest is to achieve an important set of caching rules. Ideally the URL argument to <code>--footer-html</code> would be a static HTML file. However, if want to use Rails templating to render that file, it is important to cache the results. The parent document will request this URL for each page it renders, so you can see how one process could deadlock another if your were not careful. In my example above, I override ActionController's perform_caching class and instance methods so that all actions in this controller would cache. I recommend committing a cached footer html page to any source control you have for deployment.
</p>

<p>
  With that out of the way, what about the content of the footer HTML page? Again, here is a HAML template I used. This is very much like my pdf layout with one important difference, some JavaScript that is used to parse the query parameters that wkhtmltopdf tacks onto each header/footer URL request. In the example below I am only using the current page <code>page</code> and total page count <code>topage</code> params and inserting those values into to elements. For a full list of all the query parameters, consult the wkhtmltopdf expanded help page.
</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">!!!</span> <span class="mi">5</span>
<span class="o">%</span><span class="n">html</span><span class="p">{</span><span class="ss">:lang</span> <span class="o">=&gt;</span> <span class="s1">'en'</span><span class="p">}</span>
  <span class="o">%</span><span class="n">head</span>
    <span class="o">%</span><span class="n">meta</span><span class="p">{</span><span class="ss">:charset</span> <span class="o">=&gt;</span> <span class="s1">'utf-8'</span><span class="p">}</span>
    <span class="o">=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"</span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">protocol</span><span class="si">}#{</span><span class="n">request</span><span class="p">.</span><span class="nf">host_with_port</span><span class="si">}</span><span class="s2">/stylesheets/pdf.css"</span>
    <span class="ss">:javascript</span>
      <span class="n">var</span> <span class="n">pdfInfo</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="n">var</span> <span class="n">x</span> <span class="o">=</span> <span class="n">document</span><span class="p">.</span><span class="nf">location</span><span class="p">.</span><span class="nf">search</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="s1">'&amp;'</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="n">i</span> <span class="k">in</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="n">var</span> <span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="n">pdfInfo</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">unescape</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="p">}</span>
      <span class="n">function</span> <span class="n">getPdfInfo</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">var</span> <span class="n">page</span> <span class="o">=</span> <span class="n">pdfInfo</span><span class="p">.</span><span class="nf">page</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">var</span> <span class="n">pageCount</span> <span class="o">=</span> <span class="n">pdfInfo</span><span class="p">.</span><span class="nf">topage</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="s1">'pdfkit_page_current'</span><span class="p">).</span><span class="nf">textContent</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
        <span class="n">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="s1">'pdfkit_page_count'</span><span class="p">).</span><span class="nf">textContent</span> <span class="o">=</span> <span class="n">pageCount</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="o">%</span><span class="n">body</span><span class="p">{</span><span class="ss">:onload</span> <span class="o">=&gt;</span> <span class="s1">'getPdfInfo()'</span><span class="p">}</span>
    <span class="o">%</span><span class="n">div</span><span class="c1">#pdfkit_page_numbers</span>
      <span class="o">%</span><span class="n">span</span> <span class="no">Page</span><span class="p">:</span>
      <span class="o">%</span><span class="n">span</span><span class="c1">#pdfkit_page_current</span>
      <span class="o">%</span><span class="n">span</span> <span class="n">of</span>
      <span class="o">%</span><span class="n">span</span><span class="c1">#pdfkit_page_count</span>
</code></pre></div>
<p>
  Hopefully this helps anyone looking to use PDFKit or any system that leverages the wkhtmltopdf project. If I missed anything or can help, please leave me a comment. Thanks!
</p>

  <footer class="ms-Post-footer">
    

<section id="disqus_thread">
</section>
<script type="text/javascript">
  var disqus_shortname = 'metaskillsnet';
  var disqus_identifier = '/2011/03/20/pdfkit-overview-and-advanced-usage';
  var disqus_title = "PDFKit Overview & Advanced Usage";
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  </footer>
</article>

    
    <footer class="ms-Footer">
  <p>
    &copy; 2006-2015 Ken Collins. All rights reserved.<br/>
    MetaSkills.net is powered by <a href="http://jekyllrb.com">Jekyll</a> and <a href="http://disqus.com">Disqus</a>.
  </p>
</footer>

  </article>
</section>

    <script src="/assets/site.js"></script>
  </body>
</html>
