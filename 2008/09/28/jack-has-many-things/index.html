<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="author" content="Ken Collins" />
  <meta name="google-site-verification" content="W3DG-CkoWHypH24OfrGmGbMezvhC6AyLql4jLI7hXhI" />
  <meta name="description" content="The personal blog of Ken Collins aka MetaSkills" />
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="cleartype" content="on">
  
  <title>Jack has_many :things - Ken Collins @MetaSkills.net</title>
  <link rel="author" href="mailto:ken@metaskills.net" />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/site/icon-57x57.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/site/icon-114x114.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/site/icon-72x72.png">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/site/icon-144x144.png">
  <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/site/icon-60x60.png">
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/site/icon-120x120.png">
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/site/icon-76x76.png">
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/site/icon-152x152.png">
  <link rel="icon" type="image/png" sizes="196x196" href="/assets/site/icon-196x196.png">
  <link rel="icon" type="image/png" sizes="160x160" href="/assets/site/icon-160x160.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/site/icon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/site/icon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/site/icon-32x32.png">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://metaskills.net/feed.xml" />
  <meta name="apple-mobile-web-app-title" content="MetaSkills">
  <meta name="application-name" content="MetaSkills" />
  <meta name="msapplication-TileImage" content="/assets/site/icon-144x144.png">
  <meta name="msapplication-TileColor" content="052838">
  <link rel="stylesheet" href="/assets/site.css">
</head>

  <body>
    <section class="ms-Page ">
  <header class="ms-Page-header">
    <section class="ms-Page-header-bg">
      <object class="ms-Page-header-bg-svg" data="/assets/site/page-svg.svg" type="image/svg+xml"></object>
    </section>
    <section class="ms-Page-header-content">
      <div class="ms-Page-header-avatar">
<a class="ms-Avatar" href="/pages/colophon.html" title"About Ken Collins">
  <div class="ms-Avatar-flipable">
    <div class="ms-Avatar-front">
      <img class="ms-Avatar-img" alt="Ken Collins" src="/assets/site/avatar.jpg">
    </div>
    <div class="ms-Avatar-back">
      <svg class="ms-Avatar-aboutme" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="350px" height="47px" viewBox="0 0 350 47" preserveAspectRatio="xMidYMax meet" version="1.1"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(1.000, 1.000)"><path d="M161.250 4.91 L-0.014 -0.12 L17.975 44.67 L178.787 37.22 L330.559 44.67 L347.824 -0.12 L161.250 4.91 Z" fill="#E4522A"/><g stroke="#FFFBE1"><path d="M275.89 25.53 L290.71 25.53 L287.55 20.31 L321.9 20.31 "/><path d="M276.55 22.54 L291.36 22.54 L288.2 17.33 L322.56 17.33 "/></g><g stroke="#FFFBE1"><path d="M72.76 25.53 L57.94 25.53 L61.1 20.31 L26.75 20.31 "/><path d="M72.1 22.54 L57.29 22.54 L60.45 17.33 L26.09 17.33 "/></g></g><path d="M89.184 15.23 L81.776 15.23 L81.724 15.52 C83.226 16.68 83.64 17.12 83.64 18.6 L83.641 31.76 L89.184 31.76 L89.184 27.43 L90.842 27.43 C91.955 27.43 92.19 28.05 92.19 29.04 L92.189 31.76 L97.732 31.76 L97.732 27.98 C97.732 24.92 96.9 24.04 93.64 24.04 L98.327 15.23 L92.189 15.23 L89.184 24.74 L89.184 15.23 Z M113.357 25.72 L113.357 21.99 L109.109 21.99 L109.109 19.14 L115.247 19.14 L115.247 15.23 L101.701 15.23 L101.649 15.52 C103.151 16.68 103.57 17.12 103.57 18.6 L103.566 31.76 L115.507 31.76 L115.507 28.03 L109.109 28.03 L109.109 25.72 L113.357 25.72 Z M119.346 15.23 L119.294 15.52 C120.797 16.68 121.21 17.12 121.21 18.6 L121.211 31.76 L126.754 31.76 L126.754 18.83 L129.008 18.83 C129.888 18.83 130.02 19.12 130.02 20 L130.018 31.76 L135.561 31.76 L135.561 19.84 C135.561 16.48 134.68 15.23 131.05 15.23 L119.346 15.23 Z M161.112 25.88 L161.112 26.92 C161.112 28.05 160.91 28.37 160.08 28.37 L159.014 28.37 C158.160 28.37 157.95 28.05 157.95 26.92 L157.952 20.26 C157.952 19.12 158.16 18.86 159.01 18.86 L160.076 18.86 C160.905 18.86 161.11 19.12 161.11 20.26 L161.112 23 L166.707 23 L166.707 20.05 C166.707 16.43 165.8 15.23 162.43 15.23 L156.631 15.23 C153.264 15.23 152.36 16.43 152.36 20.05 L152.357 26.53 C152.357 30.72 153.89 31.76 156.92 31.76 L162.433 31.76 C165.801 31.76 166.71 30.88 166.71 27.12 L166.707 25.88 L161.112 25.88 Z M186.606 20.05 C186.606 16.43 185.7 15.23 182.33 15.23 L176.375 15.23 C173.008 15.23 172.1 16.43 172.1 20.05 L172.101 26.53 C172.101 30.72 173.63 31.76 176.66 31.76 L182.332 31.76 C185.700 31.76 186.61 30.88 186.61 27.12 L186.606 20.05 Z M181.011 26.92 C181.011 28.05 180.8 28.37 179.97 28.37 L178.758 28.37 C177.903 28.37 177.7 28.05 177.7 26.92 L177.696 20.26 C177.696 19.12 177.9 18.86 178.76 18.86 L179.975 18.86 C180.804 18.86 181.01 19.12 181.01 20.26 L181.011 26.92 Z M198.216 15.23 L190.808 15.23 L190.757 15.52 C192.259 16.68 192.67 17.12 192.67 18.6 L192.673 31.76 L203.863 31.76 L203.863 28.03 L198.216 28.03 L198.216 15.23 Z M214.230 15.23 L206.822 15.23 L206.770 15.52 C208.272 16.68 208.69 17.12 208.69 18.6 L208.687 31.76 L219.877 31.76 L219.877 28.03 L214.230 28.03 L214.230 15.23 Z M230.244 15.23 L222.836 15.23 L222.784 15.52 C224.286 16.68 224.7 17.12 224.7 18.6 L224.700 31.76 L230.244 31.76 L230.244 15.23 Z M234.653 15.23 L234.601 15.52 C236.103 16.68 236.52 17.12 236.52 18.6 L236.518 31.76 L242.061 31.76 L242.061 18.83 L244.314 18.83 C245.195 18.83 245.32 19.12 245.32 20 L245.325 31.76 L250.868 31.76 L250.868 19.84 C250.868 16.48 249.99 15.23 246.36 15.23 L234.653 15.23 Z M268.410 15.23 L258.696 15.23 C256.805 15.23 256.13 16.06 256.13 17.36 C256.132 17.88 256.37 18.55 256.7 19.07 L261.753 27.07 C261.830 27.18 261.88 27.36 261.88 27.51 C261.882 27.82 261.65 28.03 261.18 28.03 L255.743 28.03 L255.743 31.76 L266.130 31.76 C268.073 31.76 268.8 30.49 268.8 29.45 C268.798 28.75 268.49 28.21 268.18 27.74 L262.970 20.13 C262.841 19.92 262.76 19.77 262.76 19.61 C262.763 19.33 263.02 19.14 263.49 19.14 L268.410 19.14 L268.410 15.23 Z" fill="#FFFBE1"/></g></svg>

    </div>
  </div>
</a>
</div>
      <ul class="ms-Page-nav">
        <li class="ms-Page-nav-item">
          <a class="ms-Page-nav-link" href="/">HOME</a>
        </li>
        
          
          
          <li class="ms-Page-nav-item">
            <a class="ms-Page-nav-link" href="/categories/programming.html">Programming</a>
          </li>
        
          
          
          <li class="ms-Page-nav-item">
            <a class="ms-Page-nav-link" href="/categories/lifestyle.html">Lifestyle</a>
          </li>
        
      </ul>
      <div class="ms-Page-social"><div class="ms-Social">
  <a href="http://twitter.com/metaskills" title="MetaSkills On Twitter">
    <span class="ms-Social-icon ms-Social-icon--twitter"><i class="icon-twitter"></i></span>
  </a>
  <a href="https://github.com/metaskills/" title="MetaSkills On GitHub">
    <span class="ms-Social-icon ms-Social-icon--github"><i class="icon-github"></i></span>
  </a>
  <a href="http://www.linkedin.com/in/metaskills" title="Ken Collins On LinkedIn">
    <span class="ms-Social-icon ms-Social-icon--linkedin"><i class="icon-linkedin"></i></span>
  </a>
</div>
</div>
      <div class="ms-Page-blurb">
        Ruby, JavaScript, Sass, iOS. Stinky Cheese &amp; Beer Advocate. Working at CustomInk and loving it!
      </div>
    </section>
  </header>
  <article class="ms-Page-article">
    <article class="ms-Post">
  <header class="ms-Post-header">
    <time class="ms-Post-time" pubdate datetime="2008-09-28T00:00:00-04:00">
      2008 September 28
    </time>
    <h1 class="ms-Post-header-h1">Jack has_many :things</h1>
  </header>
  <p>
  <img src="/assets/jack.png" alt="Jack Has Many Things" class="ms-Img ms-Img--responsive ms-Img--fancy" /> I am Jack's sofa, stereo and wardrobe... I make Jack's life complete. I reside in a ActiveRecord table called "things" and Jack is the only one that has the key. This is Jack's life, and it's ending one minute at a time.
</p>

<p>
  As rails developers, we have done this simple relationship over and over again. I'm sure the has_many association is by far the most common in app/db design. It gives a single resource quick and easy access to others, but as your application grows, and depression sets in, we have to open up.
</p>

<h2>It's cheaper than a movie, and there's free coffee.</h2>

<p>
  <img src="/assets/bob.png" alt="Jack With Bob" class="ms-Img ms-Img--responsive ms-Img--fancy" /> I am talking about groups. Not the underground ones that carve us out of wood, but ones where we share with those around us. This is healing. The time has come to for our objects to do the same, but how?
</p>

<p>
  The problem is that the ActiveRecord has_many association is scoped to an individual. No matter what conditions are tacked on, they are always <a href="http://en.wikipedia.org/wiki/Pwn">pwned</a> by the proxy owner. The things they own have ended up owning you! Sure we could model some groupable schema and go through it, ActiveRecord is beautiful that way. But what about our hard work in all those existing has_many associations and scopes?
</p>

<h2>I felt like destroying something beautiful.</h2>

<p>
  The solution is on everyone's face, it is on the tip of everyone's tongue. I just gave it a name. It is called <a href="http://github.com/metaskills/grouped_scope/tree/master">GroupedScope</a> and it will fundamentally change the constructed SQL for the has_many associations you want to share. The best part, it will leave those associations untouched for continued use. GroupedScope even works with your existing association extensions and any scopes. Let's have a session.
</p>

<p>First we need to install the gem. So bundle up in your Gemfile.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'grouped_scope'</span><span class="p">,</span> <span class="s1">'~&gt; 3.1.0'</span>
</code></pre></div>
<p>Now let's open up our people schema and the Person model, so Jack can share. First we add a group_id column to the people table.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PeopleCanChooseAGroup</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">add_column</span> <span class="ss">:people</span><span class="p">,</span> <span class="ss">:group_id</span><span class="p">,</span> <span class="ss">:integer</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">remove_column</span> <span class="ss">:people</span><span class="p">,</span> <span class="ss">:group_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Next we declare grouped_scope on a few associations.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:things</span>
  <span class="n">has_many</span> <span class="ss">:acquaintances</span>
  <span class="n">has_many</span> <span class="ss">:problems</span>
  <span class="n">grouped_scope</span> <span class="ss">:things</span><span class="p">,</span> <span class="ss">:problems</span>
<span class="k">end</span>

<span class="vi">@jack</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">find_by_name</span><span class="p">(</span><span class="s1">'Jack'</span><span class="p">)</span>
<span class="vi">@bob</span>  <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">find_by_name</span><span class="p">(</span><span class="s1">'Bob'</span><span class="p">)</span>

<span class="vi">@jack</span><span class="p">.</span><span class="nf">update_attribute</span> <span class="ss">:group_id</span><span class="p">,</span> <span class="mi">1</span>
<span class="vi">@bob</span><span class="p">.</span><span class="nf">update_attribute</span> <span class="ss">:group_id</span><span class="p">,</span> <span class="mi">1</span>
</code></pre></div>
<p>
  So now every Person object in our app is now ready to share their <code>:things</code> and their <code>:problems</code>. I have also just arbitrarily put Jack and Bob into the same group. Declaring <code>grouped_scope</code> in the model generates a new <code>group</code> instance method that will allow us to either reflect on the group or delegate to the associations we have declared as now haveing grouped scope.
</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="vi">@jack</span><span class="p">.</span><span class="nf">group</span>   <span class="c1"># =&gt; [#&lt;Person id: 1, name: "Jack", group_id: 1&gt;, #&lt;Person id: 2, name: "Bob", group_id: 1&gt;]</span>
</code></pre></div>
<h2>We all started seeing things differently.</h2>

<p>
  The object returned by the group method, is an instance of <code>GroupedScope::SelfGrouping</code>. It is far cooler than you think. It looks and acts as an enumerable array, but in reality it is a <code>ActiveRecord::Relation</code> object that can delegate to generated grouped association reflections which mimic their originals. Essentially giving the group access to all associated objects of its members, in this case their <code>:things</code> and <code>:problems</code>. Did I loose you?
</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="vi">@jack</span><span class="p">.</span><span class="nf">problems</span><span class="p">.</span><span class="nf">size</span>   <span class="c1"># =&gt; 6</span>
<span class="vi">@bob</span><span class="p">.</span><span class="nf">problems</span><span class="p">.</span><span class="nf">size</span>    <span class="c1"># =&gt; 2</span>

<span class="vi">@bob</span><span class="p">.</span><span class="nf">group</span><span class="p">.</span><span class="nf">problems</span>        <span class="c1"># =&gt; [#&lt;Problem...&gt;,#&lt;Problem...&gt;,#&lt;Problem...&gt;,#&lt;Problem...&gt;,....]</span>
<span class="vi">@bob</span><span class="p">.</span><span class="nf">group</span><span class="p">.</span><span class="nf">problems</span><span class="p">.</span><span class="nf">size</span>   <span class="c1"># =&gt; 8</span>
<span class="vi">@jack</span><span class="p">.</span><span class="nf">group</span><span class="p">.</span><span class="nf">problems</span><span class="p">.</span><span class="nf">size</span>  <span class="c1"># =&gt; 8</span>
</code></pre></div>
<p>
  Without going into the detail of Jack's and Bob's problems, we can see that within the group, they are all shared. This is what the GroupedScope gem is really all about. It allows existing has_many associations to be called on the group which changes the SQL generated to be owned by the group, essentially from <code>id = 1</code> to <code>id IN (SELECT id FROM people WHERE group_id = 1)</code>.
</p>

<p>
  The way it accomplishes this is pretty sweet. GroupedScope creates reflections that use a custom association scope method which uses a little Arel magic to build predicate conditions. Since it copies all your existing association reflection options, it can be really smart by maintaining all the logic in the existing association. So options like <code>:class_name</code>, <code>:foreign_key</code>, <code>:though</code>, and <code>:extend</code> will just work! It also lets you chain scopes existing scopes or use your custom association extensions on the original associations. Here is very contrived example:
</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:mental_issues</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">"MentalState"</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="ss">:name</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">dangerous</span>
      <span class="n">where</span><span class="p">(</span><span class="ss">:snap_tolerance</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">grouped_scope</span> <span class="ss">:mental_issues</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">MentalState</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">scope</span> <span class="ss">:treatable_by</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">doctor</span><span class="o">|</span> <span class="n">where</span><span class="p">(</span><span class="ss">:doctor_id</span> <span class="o">=</span> <span class="n">doctor</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="vi">@jack</span><span class="p">.</span><span class="nf">group</span><span class="p">.</span><span class="nf">mental_issues</span><span class="p">.</span><span class="nf">dangerous</span><span class="p">.</span><span class="nf">treatable_by</span><span class="p">(</span><span class="vi">@doctor</span><span class="p">)</span> <span class="c1"># =&gt; [#&lt;MentalState...&gt;,#&lt;MentalState...&gt;]</span>
</code></pre></div>
<h2>This is probably one of those "cry for help" things.</h2>

<p>
  <img src="/assets/marla.png" alt="Marla" class="ms-Img ms-Img--responsive ms-Img--fancy" /> The GroupedScope gem is never quite done. It is however well tested and can do exactly all that I have outlined in ActiveRecord 3.1.0. I even have older gem versions that track our legacy 2-3-stable git branch.
</p>

<p>
  Also, you may have noticed that <code>GroupedScope</code> does not try to solve what your group business logic may look like. This is intentional and left to the end user to implement a <code>Group</code> object. This object would be the primary key owner of the <code>group_id</code> column in your models that declare grouped scope. You would also need to declare some sort of <code>belongs_to</code> association to your custom group model too.
</p>

<p>
  Lastly, if we you see something you might like in features or notice a bug, open a issue <a href="https://github.com/metaskills/grouped_scope">on our Github project</a> page.
</p>

<h2>I'd like to thank the Academy.</h2>

<ul>
  <li><a href="http://github.com/metaskills/grouped_scope/tree/master">GroupedScope Gem On Github.</a></li>
  <li><a href="http://en.wikipedia.org/wiki/Fight_Club">About the movie Fight Club.</a></li>
  <li><a href="http://decisiv.net/">My Workplace, Decisiv.</a></li>
</ul>

  <footer class="ms-Post-footer">
    

<section id="disqus_thread">
</section>
<script type="text/javascript">
  var disqus_shortname = 'metaskillsnet';
  var disqus_identifier = '/2008/09/28/jack-has_many-things/';
  var disqus_title = "Jack has_many :things";
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  </footer>
</article>

    
    <footer class="ms-Footer">
  <p>
    &copy; 2006-2018 Ken Collins. All rights reserved.<br/>
    MetaSkills.net is powered by <a href="http://jekyllrb.com">Jekyll</a> and <a href="http://disqus.com">Disqus</a>.
  </p>
</footer>

  </article>
</section>

    <script src="/assets/site.js"></script>
  </body>
</html>
