<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="author" content="Ken Collins" />
  <meta name="google-site-verification" content="W3DG-CkoWHypH24OfrGmGbMezvhC6AyLql4jLI7hXhI" />
  <meta name="description" content="The personal blog of Ken Collins aka MetaSkills" />
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="cleartype" content="on">
  
  <title>From Rails 3.2 to 4.2 - Ken Collins @MetaSkills.net</title>
  <link rel="author" href="mailto:ken@metaskills.net" />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/site/icon-57x57.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/site/icon-114x114.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/site/icon-72x72.png">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/site/icon-144x144.png">
  <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/site/icon-60x60.png">
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/site/icon-120x120.png">
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/site/icon-76x76.png">
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/site/icon-152x152.png">
  <link rel="icon" type="image/png" sizes="196x196" href="/assets/site/icon-196x196.png">
  <link rel="icon" type="image/png" sizes="160x160" href="/assets/site/icon-160x160.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/site/icon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/site/icon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/site/icon-32x32.png">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://metaskills.net/feed.xml" />
  <meta name="apple-mobile-web-app-title" content="MetaSkills">
  <meta name="application-name" content="MetaSkills" />
  <meta name="msapplication-TileImage" content="/assets/site/icon-144x144.png">
  <meta name="msapplication-TileColor" content="052838">
  <link rel="stylesheet" href="/assets/site.css">
</head>

  <body>
    <section class="ms-Page ">
  <header class="ms-Page-header">
    <section class="ms-Page-header-bg">
      <object class="ms-Page-header-bg-svg" data="/assets/site/page-svg.svg" type="image/svg+xml"></object>
    </section>
    <section class="ms-Page-header-content">
      <div class="ms-Page-header-avatar">
<a class="ms-Avatar" href="/pages/colophon.html" title"About Ken Collins">
  <div class="ms-Avatar-flipable">
    <div class="ms-Avatar-front">
      <img class="ms-Avatar-img" alt="Ken Collins" src="/assets/site/avatar.jpg">
    </div>
    <div class="ms-Avatar-back">
      <svg class="ms-Avatar-aboutme" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="350px" height="47px" viewBox="0 0 350 47" preserveAspectRatio="xMidYMax meet" version="1.1"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(1.000, 1.000)"><path d="M161.250 4.91 L-0.014 -0.12 L17.975 44.67 L178.787 37.22 L330.559 44.67 L347.824 -0.12 L161.250 4.91 Z" fill="#E4522A"/><g stroke="#FFFBE1"><path d="M275.89 25.53 L290.71 25.53 L287.55 20.31 L321.9 20.31 "/><path d="M276.55 22.54 L291.36 22.54 L288.2 17.33 L322.56 17.33 "/></g><g stroke="#FFFBE1"><path d="M72.76 25.53 L57.94 25.53 L61.1 20.31 L26.75 20.31 "/><path d="M72.1 22.54 L57.29 22.54 L60.45 17.33 L26.09 17.33 "/></g></g><path d="M89.184 15.23 L81.776 15.23 L81.724 15.52 C83.226 16.68 83.64 17.12 83.64 18.6 L83.641 31.76 L89.184 31.76 L89.184 27.43 L90.842 27.43 C91.955 27.43 92.19 28.05 92.19 29.04 L92.189 31.76 L97.732 31.76 L97.732 27.98 C97.732 24.92 96.9 24.04 93.64 24.04 L98.327 15.23 L92.189 15.23 L89.184 24.74 L89.184 15.23 Z M113.357 25.72 L113.357 21.99 L109.109 21.99 L109.109 19.14 L115.247 19.14 L115.247 15.23 L101.701 15.23 L101.649 15.52 C103.151 16.68 103.57 17.12 103.57 18.6 L103.566 31.76 L115.507 31.76 L115.507 28.03 L109.109 28.03 L109.109 25.72 L113.357 25.72 Z M119.346 15.23 L119.294 15.52 C120.797 16.68 121.21 17.12 121.21 18.6 L121.211 31.76 L126.754 31.76 L126.754 18.83 L129.008 18.83 C129.888 18.83 130.02 19.12 130.02 20 L130.018 31.76 L135.561 31.76 L135.561 19.84 C135.561 16.48 134.68 15.23 131.05 15.23 L119.346 15.23 Z M161.112 25.88 L161.112 26.92 C161.112 28.05 160.91 28.37 160.08 28.37 L159.014 28.37 C158.160 28.37 157.95 28.05 157.95 26.92 L157.952 20.26 C157.952 19.12 158.16 18.86 159.01 18.86 L160.076 18.86 C160.905 18.86 161.11 19.12 161.11 20.26 L161.112 23 L166.707 23 L166.707 20.05 C166.707 16.43 165.8 15.23 162.43 15.23 L156.631 15.23 C153.264 15.23 152.36 16.43 152.36 20.05 L152.357 26.53 C152.357 30.72 153.89 31.76 156.92 31.76 L162.433 31.76 C165.801 31.76 166.71 30.88 166.71 27.12 L166.707 25.88 L161.112 25.88 Z M186.606 20.05 C186.606 16.43 185.7 15.23 182.33 15.23 L176.375 15.23 C173.008 15.23 172.1 16.43 172.1 20.05 L172.101 26.53 C172.101 30.72 173.63 31.76 176.66 31.76 L182.332 31.76 C185.700 31.76 186.61 30.88 186.61 27.12 L186.606 20.05 Z M181.011 26.92 C181.011 28.05 180.8 28.37 179.97 28.37 L178.758 28.37 C177.903 28.37 177.7 28.05 177.7 26.92 L177.696 20.26 C177.696 19.12 177.9 18.86 178.76 18.86 L179.975 18.86 C180.804 18.86 181.01 19.12 181.01 20.26 L181.011 26.92 Z M198.216 15.23 L190.808 15.23 L190.757 15.52 C192.259 16.68 192.67 17.12 192.67 18.6 L192.673 31.76 L203.863 31.76 L203.863 28.03 L198.216 28.03 L198.216 15.23 Z M214.230 15.23 L206.822 15.23 L206.770 15.52 C208.272 16.68 208.69 17.12 208.69 18.6 L208.687 31.76 L219.877 31.76 L219.877 28.03 L214.230 28.03 L214.230 15.23 Z M230.244 15.23 L222.836 15.23 L222.784 15.52 C224.286 16.68 224.7 17.12 224.7 18.6 L224.700 31.76 L230.244 31.76 L230.244 15.23 Z M234.653 15.23 L234.601 15.52 C236.103 16.68 236.52 17.12 236.52 18.6 L236.518 31.76 L242.061 31.76 L242.061 18.83 L244.314 18.83 C245.195 18.83 245.32 19.12 245.32 20 L245.325 31.76 L250.868 31.76 L250.868 19.84 C250.868 16.48 249.99 15.23 246.36 15.23 L234.653 15.23 Z M268.410 15.23 L258.696 15.23 C256.805 15.23 256.13 16.06 256.13 17.36 C256.132 17.88 256.37 18.55 256.7 19.07 L261.753 27.07 C261.830 27.18 261.88 27.36 261.88 27.51 C261.882 27.82 261.65 28.03 261.18 28.03 L255.743 28.03 L255.743 31.76 L266.130 31.76 C268.073 31.76 268.8 30.49 268.8 29.45 C268.798 28.75 268.49 28.21 268.18 27.74 L262.970 20.13 C262.841 19.92 262.76 19.77 262.76 19.61 C262.763 19.33 263.02 19.14 263.49 19.14 L268.410 19.14 L268.410 15.23 Z" fill="#FFFBE1"/></g></svg>

    </div>
  </div>
</a>
</div>
      <ul class="ms-Page-nav">
        <li class="ms-Page-nav-item">
          <a class="ms-Page-nav-link" href="/">HOME</a>
        </li>
        
          
          
          <li class="ms-Page-nav-item">
            <a class="ms-Page-nav-link" href="/categories/programming.html">Programming</a>
          </li>
        
          
          
          <li class="ms-Page-nav-item">
            <a class="ms-Page-nav-link" href="/categories/lifestyle.html">Lifestyle</a>
          </li>
        
      </ul>
      <div class="ms-Page-social"><div class="ms-Social">
  <a href="http://twitter.com/metaskills" title="MetaSkills On Twitter">
    <span class="ms-Social-icon ms-Social-icon--twitter"><i class="icon-twitter"></i></span>
  </a>
  <a href="https://github.com/metaskills/" title="MetaSkills On GitHub">
    <span class="ms-Social-icon ms-Social-icon--github"><i class="icon-github"></i></span>
  </a>
  <a href="http://www.linkedin.com/in/metaskills" title="Ken Collins On LinkedIn">
    <span class="ms-Social-icon ms-Social-icon--linkedin"><i class="icon-linkedin"></i></span>
  </a>
</div>
</div>
      <div class="ms-Page-blurb">
        Ruby, JavaScript, Sass, iOS. Stinky Cheese &amp; Beer Advocate. Working at CustomInk and loving it!
      </div>
    </section>
  </header>
  <article class="ms-Page-article">
    <article class="ms-Post">
  <header class="ms-Post-header">
    <time class="ms-Post-time" pubdate datetime="2014-09-16T00:00:00-04:00">
      2014 September 16
    </time>
    <h1 class="ms-Post-header-h1">From Rails 3.2 to 4.2</h1>
  </header>
  <p>Last week I set out to upgrade <a href="https://homemarks.com/">HomeMarks</a>, a personal bookmarking project of mine. This application sat on a very <a href="https://homemarks.com/blog/2014-02-26-homemarks-v3-launches">recent upgrade</a> to Rails 3.2. It is written as an API to both an iOS and HTML JavaScript interface. It is by no means huge and should represent a nominal service oriented application. Here are some stats:</p>

<ul>
<li>8 Models (450 LOC)</li>
<li>11 Controllers (550 LOC)</li>
<li>2 Mailers (50 LOC)</li>
<li>8 Libraries (500 LOC)</li>
<li>Using Ruby 2.1.2.</li>
</ul>

<p>The application is heavily tested with an emphasis on controller and integrations. It uses a standard Rails test setup with simple <a href="https://github.com/metaskills/minitest-spec-rails#readme">minitest-spec-rails</a> usage. Integrations are done using the Capybara DSL with the <a href="https://github.com/teampoltergeist/poltergeist">Poltergeist</a> driver. JavaScript tests use <a href="https://github.com/jfirebaugh/konacha">Konacha</a> which leverage MochaJS and the Chai assertion library.</p>

<p>With the introductions out of the way let&#39;s do some fun upgrade work! Here is a step by step process of how I tackled the task and I hope you find it useful.</p>

<h2 id="grease-the-wheels">Grease The Wheels</h2>

<p>The first step I always recommend for any Rails upgrade is to update your entire bundle with your current Rails semver as the only gem constraint. The goal here is to have no gem versions other than <code>~&gt; 3.2</code> for Rails itself in your Gemfile - hence allowing Bundler to do all the work during your big 4.2 update. For this reason you should delete any explicit gem version specs and run <code>bundle update</code>.</p>

<p>During this time you will want to remove any non-essential gems as well. Great examples are test related gems. Spending time debugging any non-essential gem during an upgrade process is the worst time spent of all. Likewise, identify gems that are obsolete in your target upgrade. In my application, good examples were the <code>mail_view</code> and the <code>quiet_assets</code> gems. Hopefully your application has a tagging convention for notes when upgrading. At CustomInk, we use <code>PENDING: [Rails4]...</code> style comment tags.</p>

<p>Once done, update your master branch with this work and get that deployed. This is your new base for the push to Rails 4.2.</p>

<h2 id="make-a-template">Make A Template</h2>

<p>We want to reference a fresh 4.2 application as a guide. This will come in handy in many ways later on. During the time of this article Rails 4.2 was in beta1, so all examples will use that version. Please adjust your commands/examples as newer versions are released.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>gem install rails 4.2.0.beta1
<span class="gp">$ </span>rbenv rehash
<span class="gp">$ </span>rails new myapp
</code></pre></div>
<h2 id="the-big-bundle-update">The Big Bundle Update</h2>

<p>We need to focus on the Gemfile first. Start by changing that <code>~&gt; 3.2</code> twiddle-wakka to our target version of <code>~&gt; 4.2.0.beta1</code> as our Rails gem version. Go through your notes and delete those obsolete gems too and make any adjustments to any pessimistic version if you noted any.</p>

<p>In Rails 4.2, there is no such thing as an <code>assets</code> group for gems. So I removed my <code>group :assets</code> and flattened my asset gems to the root of the Gemfile. I do suggest maintaining an comment and clustering your asset gems in your Gemfile as a way to keep them organized. Due to <code>sass-rails</code> being in beta, I ended up with something like this.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span>
<span class="n">gem</span> <span class="s1">'pg'</span>
<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'~&gt; 4.2.0.beta1'</span> <span class="c1"># PENDING: [Rails 4.2] Remove wakka.</span>

<span class="c1"># Assets</span>
<span class="n">gem</span> <span class="s1">'bourbon'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span>
<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 5.0.0.beta1'</span> <span class="c1"># PENDING: [Rails 4.2] Remove wakka.</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span>
</code></pre></div>
<p>Lastly, I find it extremely useful to delete the <code>Gemfile.lock</code> now. In my experience Bundler will have a much better time coping by allowing the entire dep graph to be rebuilt. Now go for the big update with a simple bundle install.</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ bundle install
</code></pre></div>
<p>If you run into any problems here, take them on one by one. In some cases you could be using a gem that does not optimistically include 4.x versions. Before proceeding, find each project&#39;s issue tracker and do a little research. If you encounter resistance, look broadly first and avoid hacking around it. This could be your time to shine and help with an open source pull request.</p>

<p>Once you are bundled, you are ready for the next step. <strong>Avoid the temptation to launch your application or running tests!</strong> You are no where near ready for that, so slow your roll. We still have some good work to do.</p>

<h2 id="the-mimic-process">The Mimic Process</h2>

<p>This is a great time to open the template application we created above. It is a very straightforward process to go through each of the application&#39;s files &amp; folders and mimic the template within your own application.</p>

<p>In my experience I have seen a lot of pain in converting over <code>config/environments</code> files to the newer format. If you have never done so, I highly recommend following a simple practice that makes upgrading of these files easier in the future. Always keep the environment file largely untouched and add your configs to the bottom of each below a comment like this.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>

  <span class="c1"># ... Rails generated ...</span>

  <span class="c1"># My Configs</span>
  <span class="c1"># ----------</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">show_previews</span>

<span class="k">end</span>
</code></pre></div>
<p>This makes updating these files in the future go much quicker. Here are some general notes I had when doing my entire mimesis process.</p>

<h4 id="environments-amp-initializers">Environments &amp; Initializers</h4>

<ul>
<li>Removed <code>config.filter_parameters</code> from application.rb to config/initializers/filter_parameter_logging.rb</li>
<li>The <code>config.assets.precompile</code> and <code>config.assets.version</code> have moved to config/initializers/assets.rb</li>
<li>Many files now use the <code>Rails.application</code> singleton resource vs <code>MyApp::Application</code> constant.</li>
</ul>

<h4 id="concerns-directories">Concerns Directories</h4>

<p>I fully embraced the new concern directories. I created both <code>app/controllers/concerns/.keep</code> and <code>app/models/concerns/.keep</code>. I found there were a few files in my lib directory that were actually concerns. For example, I moved both my AuthenticatedSystem and RenderInvalidRecord modules to the controller concerns. This allowed me to remove any hacks I had for setting the auto load path on the lib directory too.</p>

<h4 id="bin-directory-amp-spring">Bin Directory &amp; Spring</h4>

<p>I have been using both bundler bin stubs and Spring in all of my 3.2 applications. Now that Rails supports both the local <code>bin</code> directory and Spring in an integrated way, I wanted to follow the golden path of least resistance.</p>

<p>The first step was to blow away my entire bin directory and just copy over the one from the application template. These new bin files for <code>rake</code> and <code>rails</code> leverage the Spring preloader. Make sure to delete your local or global bundle config for installing bins too. Do this with <code>bundle config --delete bin</code>. Now, instead of having Bundler install bin stubs for every gem which could conflict with the preloader bins, we should be explicit on a per gem basis. For example, this would install the bins for guard.</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ bundle binstubs guard
</code></pre></div>
<p>Lastly, if you have never done so, change your shell&#39;s <code>PATH</code> to look for the local <code>./bin</code> directory before any others. I do this after my rbenv initialization.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">eval</span> <span class="s2">"</span><span class="k">$(</span>rbenv init -<span class="k">)</span><span class="s2">"</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"./bin:</span><span class="nv">$PATH</span><span class="s2">"</span>
</code></pre></div>
<h4 id="routes-file">Routes File</h4>

<ul>
<li>Removed my <code>match</code> methods in favor of <code>get</code> verb method.</li>
</ul>

<h4 id="new-test-directories">New Test Directories</h4>

<ul>
<li>Renamed <code>test/functional</code> folder to <code>test/controllers</code></li>
<li>Renamed <code>test/unit</code> folder to <code>test/models</code></li>
<li>Created a <code>test/mailers</code> folder and moved all my mailer tests from units to it.</li>
<li>Renamed <code>ActionController::IntegrationTest</code> to <code>ActionDispatch::IntegrationTest</code>.</li>
</ul>

<h2 id="framework-changes">Framework Changes</h2>

<p>Now is the time where you can start to run your tests and identify what needs to change. I recommend starting with the model tests and moving on from there. Though I am a big fan of Guard for automatic test runs, Rails now has a new option when using rake. Just pass the filename after the test argument. For example, this would run a single model test and since the new <code>bin/rake</code> file uses Spring, you can run this command over and over again very quickly.</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ rake test test/models/user_test.rb
</code></pre></div>
<p>Below are things I found while moving through my tests. I have organized them by framework. They are by no means comprehensive and your application may expose more differences between Rails 3.2 and 4.2.</p>

<h4 id="activerecord">ActiveRecord</h4>

<p>You are going to see a lot of <code>ArgumentError: Unknown key: ...</code> errors. The reason is that Rails 4.0 now requires that scopes use a callable object such as a Proc or lambda. I saw these errors mostly on <code>:order</code> and the <code>:readonly</code> option arguments. Here are a few before/after examples.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Old</span>
<span class="n">has_many</span> <span class="ss">:foos</span><span class="p">,</span> <span class="ss">order: </span><span class="s1">'position'</span>
<span class="n">has_many</span> <span class="ss">:bars</span><span class="p">,</span> <span class="ss">through: :foos</span><span class="p">,</span> <span class="ss">readonly: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">order: </span><span class="s1">'foos.position, bars.position'</span>

<span class="c1"># New</span>
<span class="n">has_many</span> <span class="ss">:foos</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'position'</span><span class="p">)</span> <span class="p">}</span>
<span class="n">has_many</span> <span class="ss">:bars</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'foos.position, bars.position'</span><span class="p">).</span><span class="nf">readonly</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span> <span class="p">},</span> <span class="ss">through: :foos</span>
</code></pre></div>
<p>Seems the callable object has to be the second argument and you can easily chain the scopes within. I took a wild guess that the <code>readyonly</code> scope took an optional <code>false</code> argument and was handsomely rewarded.</p>

<p>I also got a few good <code>ArgumentError: The provided regular expression is using multiline anchors (^ or $) ...</code> errors. This was easy to fix by using the suggested \A and \z instead. Really happy to see the framework warning on this common errors when using regular expressions for validations.</p>

<p>I deleted all the <code>attr_accesible</code> declarations from my models and switched to strong parameters in the controllers. If you are new to strong parameters, <a href="http://easyactiverecord.com/blog/2014/04/01/rails4-strong-parameters-and-the-attr-accessible-macro">check out this article</a> which goes into great depth on the topic. Alternatively, you can start using strong parameters before you upgrade to Rails 4.x by using the backward compatible <a href="https://github.com/rails/strong_parameters">strong parameters gem</a>. A great strategy to ease large application transitions. Thanks to <a href="http://about.me/cmar">Chris Mar</a> for pointing out this approach to our team.</p>

<p>The class <code>update_all</code> no longer takes a second conditions argument. I always disliked methods that took two option hashes and this is a great change. For example:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Old</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">update_all</span><span class="p">({</span><span class="ss">author: </span><span class="s1">'David'</span><span class="p">},</span> <span class="p">{</span><span class="ss">title: </span><span class="s1">'Rails'</span><span class="p">})</span>

<span class="c1"># New</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">title: </span><span class="s1">'Rails'</span><span class="p">).</span><span class="nf">update_all</span><span class="p">(</span><span class="ss">author: </span><span class="s1">'David'</span><span class="p">)</span>
</code></pre></div>
<p>Lastly, the <code>all</code> method no longer takes finder options.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Old</span>
<span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="n">conditions</span><span class="p">:{</span><span class="n">email</span><span class="ss">:'ken@metaskills.net'</span><span class="p">}).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>

<span class="c1"># New</span>
<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">email</span><span class="ss">:'ken@metaskills.net'</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
</code></pre></div>
<h4 id="actionmailer">ActionMailer</h4>

<p>Using <code>_path</code> url methods in mailers will now result in a <code>DEPRECATION WARNING... cannot be used here as a full URL is required</code> message. Unless you were manually augmenting these paths to have a host, this is a good thing and will keep developers from including partial URLs in mailers.</p>

<p>MailView is now fully integrated into ActionMailer. Read <a href="http://brewhouse.io/blog/2013/12/17/whats-new-in-rails-4-1.html">this article</a> for full details. If you have never used MailView in a Rails 3 application, it allows you to develop your mails in the browser as if they were controller view. When moving from old MailView support to Rails 4.x usage, follow these steps:</p>

<ul>
<li>Add <code>config.action_mailer.show_previews</code> to config/environments/development.rb file.</li>
<li>Moved previous mailer previews to new <code>test/mailers/previews</code> directory.</li>
</ul>

<h4 id="actionpack">ActionPack</h4>

<p>Partials can no longer have <code>-</code> hyphens in the filename. I had to change a few.</p>

<p>There is a new and <a href="https://github.com/rails/rails/blob/master/actionpack/lib/action_controller/metal/request_forgery_protection.rb">better request forgery protection</a> in Rails 4.x. Read the source link for full error messages and documentation. In my case, I had already redefined a protected <code>protect_against_forgery?</code> for a special controller and needed to only add <code>skip_before_action :verify_authenticity_token</code> to my filters to fully work around the security warning.</p>

<h4 id="asset-pipeline">Asset Pipeline</h4>

<p>The biggest issue that I had is that asset compilation no longer generates non-digest filenames for each asset. This <a href="https://github.com/rails/sprockets-rails/issues/49">github issue</a> explains the rationale, but I do believe there are some corner cases where you do want to reference the non-digest asset filename.</p>

<p>If after careful examination you find yourself in need of this corner case, do not disable digests for all files. Instead install the <a href="https://github.com/alexspeller/non-stupid-digest-assets">non-stupid-digest-assets</a> gem which allows you to whitelist specific asset files and thereby including a non-digest filename along with the fingerprinted filenames for said asset(s). I recommend putting the <code>NonStupidDigestAssets.whitelist</code> settings at the bottom of the new <code>config/initializers/assets.rb</code> file.</p>

<h4 id="testing">Testing</h4>

<p>The Rails testing task strategy has changed a lot. By default now, when you run <code>rake test</code> all models, mailers, controllers and integrations are run in one collective suite run. If you are interested in learning how, read the <a href="https://github.com/rails/rails/blob/master/railties/lib/rails/test_unit/testing.rake">testing.rake</a> source. I also talked about how to add different directories to this process within a <a href="https://github.com/metaskills/minitest-spec-rails/issues/49">github issues under the minitest-spec-rails</a> project where <a href="http://blowmage.com">Mike Moore</a> contributed a few helpful hints too.</p>

<p>The reason I mention this is that it is somewhat common to expect your Capybara enhanced integrations to run in a distinct process. Because of this, it is also common to see monkey patches to the ActiveRecord connection pool to support integration tests that leverage DB transactions. Depending on your setup, you may be required to make a few tweaks.</p>

<h2 id="in-closing">In Closing</h2>

<p>Upgrading Rails applications used to be a pain! My recent upgrade only took two evenings of my spare time. In my opinion Rails 3.1 and up have become much more stable for both application and gem authors to leverage the framework. Thus making upgrades approachable. Keep your applications small and focused as a way to win the upgrade wars!</p>

<p>In closing, thanks for reading and I hope you found this information helpful. If you have any questions, feel free to ask in the comments. Cheers!</p>

  <footer class="ms-Post-footer">
    

<section id="disqus_thread">
</section>
<script type="text/javascript">
  var disqus_shortname = 'metaskillsnet';
  var disqus_identifier = '/2014/09/16/from-rails-3-2-to-4-2/';
  var disqus_title = "From Rails 3.2 to 4.2";
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  </footer>
</article>

    
    <footer class="ms-Footer">
  <p>
    &copy; 2006-2017 Ken Collins. All rights reserved.<br/>
    MetaSkills.net is powered by <a href="http://jekyllrb.com">Jekyll</a> and <a href="http://disqus.com">Disqus</a>.
  </p>
</footer>

  </article>
</section>

    <script src="/assets/site.js"></script>
  </body>
</html>
